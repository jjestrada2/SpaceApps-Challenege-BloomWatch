---
title: Connecting to PostGIS
description: Mundi can connect to external PostGIS databases for exploration, analysis, and visualization.
---

Mundi can connect to pre-existing PostGIS databases and can create visualization layers from PostGIS tables via custom queries,
generate Wiki-like documentation of your database schema, and execute queries to answer questions about the data.

## Connecting for the first time

### 1. Click the 'Load PostGIS' button in the layer list

![Click the Add PostGIS button](../../../assets/postgis/add_postgis.jpg)


### 2. Enter connection details

You should prefer [read-only users](#creating-a-read-only-user-for-mundi) for security.

![PostGIS Connection Dialog](../../../assets/postgis/connection_details.png)

If someone else hosts your database, you should ask them for these details.

### Migrating from QGIS

You can also connect to the same PostGIS database that you normally use from QGIS as long as it's not hosted locally.

![Connecting from QGIS](../../../assets/postgis/from-qgis.png)

This allows you to work with the same spatial data across both Mundi and QGIS environments.

## Working with PostGIS database

Give the database some time to load. During this time, Mundi is generating wiki-like documentation about
your database schema.

:::note[Be patient!]
One US-located database with 100 tables will take 2-5 minutes to load. If your database is located outside
of the US (for Mundi cloud) or has 1,000+ tables this may take 10+ minutes.
:::

![postgis connection is loading](../../../assets/postgis/loading.png)

Once it's loaded, it will appear in your project's database list, with an AI generated name and table count.

![AI generated database name](../../../assets/postgis/loaded.png)

### AI database documentation

You can hover over the database name and click on it to view the generated wiki page.

![AI generated wiki documentation for PostGIS database](../../../assets/postgis/wiki.png)

The wiki page is generated by an AI model that sees your database schema, example data, foreign key
relationships, etc. It includes diagrams explaining the how different tables relate to eachother:

![PostGIS table foreign key relationships](../../../assets/postgis/diagram.png)

### Creating layers from PostGIS queries

Once connected, you can ask Kue, the AI assistant in Mundi, to create new map layers that source
spatial data from the connected PostGIS database.

:::tip[Request to Kue]
can you add a layer for the wellbores from my postgis database?
:::


![Kue request to add new layer](../../../assets/postgis/request_add_layer.jpg)

This creates a dynamic layer in Mundi that continuously pulls data from your PostGIS database:

![Mundi dynamic PostGIS layer served from database](../../../assets/postgis/wellbores.jpg)



## Connecting to a local PostGIS

If your PostGIS database is on your local computer (`localhost`) or on a private server,
you can use a tunneling service, like [ngrok](https://ngrok.com/), to temporarily expose
it to Mundi cloud. Here, I've used `ngrok` to expose my local PostGIS database on `localhost:5433`
to [Mundi cloud](https://app.mundi.ai):

```bash
$ ngrok tcp 5433
```

This will give us a host and port to give to Mundi, which will proxy Mundi's queries to your local database.
When you close the tunnel with `Ctrl+C`, Mundi will lose access to the database.

![ngrok PostGIS connection details](../../../assets/ngrok/ngrok.jpeg)

ngrok says that we should put the host as `2.tcp.ngrok.io` and the port as `19921`. Username, password,
database, and schema all stay the same.

![ngrok PostGIS connection details](../../../assets/ngrok/ngrok-add-connection.jpg)

Once the connection loads, you'll be able to ask Kue to create layers and execute SQL queries. Map tiles
are served through the tunnel from your local database, which may slow down your computer depending on how many
rows are in your tables.

![ngrok PostGIS connection details](../../../assets/ngrok/postgis-layer.jpg)


:::danger[PostgreSQL Security]
While using a tunnel service is generally **more secure** than permanently exposing the same database to the public internet
(because the host and port rotate each time you restart the tunnel), it is important to use a **long and random password**
for your PostGIS database. Bots continuously scan tunnel services for exposed databases with insecure passwords (along with
the rest of the internet).
:::


## Best practices and errors

### Whitelist Mundi egress IP addresses

Mundi will always connect to your Postgres from the below IP addresses. By whitelisting them while rejecting other connections, you'll increase the security of your database.

Allow on TCP 5432: `34.44.109.93/32`, `34.27.218.71/32` (both). The `/32` means a single IP address.

**Docs by host**
- **AWS RDS/Aurora (Postgres):** [Security groups](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Overview.RDSSecurityGroups.html).
- **GCP Cloud SQL (Postgres):** ["Authorized networks"](https://cloud.google.com/sql/docs/postgres/authorize-networks).
- **Azure Database for PostgreSQL (Flexible Server):** [Firewall rules](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/security-firewall-rules).
- **DigitalOcean Managed PostgreSQL:** [Trusted Sources](https://docs.digitalocean.com/products/databases/postgresql/how-to/secure/).
- **Self-hosted Postgres:** [pg_hba.conf](https://www.postgresql.org/docs/current/auth-pg-hba-conf.html).

### Creating a read-only user for Mundi

We recommend that users create read-only database users for Mundi to use. This read-only user should only
have access to the tables that you intend to use Mundi to analyze.


Here is how you might go about creating this user:

```sql
CREATE USER mundi_readonly WITH PASSWORD '...';
GRANT SELECT ON spatial_table_1, polygon_table_2 TO mundi_readonly;
```

Opened connections to third-party PostGIS databases from Mundi are always opened as read-only, so there are only
additional risks to allowing the user write access.

:::caution
For databases requiring high data privacy, we always recommend either on-premise deployment of Mundi
cloud or self-hosting Mundi open source.
:::


### Options when self-hosting Mundi open source

You can set the environment variable `POSTGIS_LOCALHOST_POLICY` to one of the following values:
- `disallow` prevents users from connecting to loopback addresses, which can help prevent unauthorized
  access and connections to databases running on the host machine
- `rewrite` which is useful for connecting to PostgreSQL running on the host machine. This tells Docker to
  redirect localhost to the host machine, instead of the Docker container
- `allow` to allow connections to localhost databases. Because Docker localhost is different from your
  computer's localhost, this rarely makes sense

### Debugging common problems

If your PostGIS database fails to connect, hover over the connection error to see the full error message.

![PostGIS connection error message in Mundi](../../../assets/postgis/timeout_error.png)

If you've looked into the below issues and can't connect, you can ask in our [community Discord](https://discord.gg/V63VbgH8dT).

#### Localhost databases on Mundi cloud

If you normally connect to your database from QGIS or similar using `localhost` or `127.0.0.1`, the database
is running on your local computer and will not be accessible from Mundi cloud (or any other cloud service).

![Mundi detected a localhost database address](../../../assets/postgis/localhost_error.png)


You would need to create a replica of your PostgreSQL database on a cloud provider and provide us that
connection string instead to connect Mundi to your data.

#### Connection timeout

If the connection times out (Mundi defaults to 10 second limit), it's likely that the database
is not accessible from the internet, either due to a firewall or the database is on your local
network. In order to be accessible, the database must be pinned to a public static IPv4 address
allowing ingress and egress traffic.

#### SSL connection rejected

If your Postgres database doesn't have SSL configured correctly, by default Mundi
will give you an error when connecting to it:

```
ConnectionError: PostgreSQL server at "..." rejected SSL upgrade
```

**Option 1: Enable SSL:** Enable SSL connections on your PostgreSQL server. This involves
editing `pg_hba.conf`. Either ask your database administrator, or follow a
tutorial online.

**Option 2: Disable SSL (insecure)**: Instructs Mundi to not encrypt data when connecting. Add `?sslmode=disable` to your connection string. This will make the connection work, but result in data
from your database being sent unencrypted through the Internet:

```
postgresql://user:pass@hostname:5432/db?sslmode=disable
```

## Row Level Security (RLS)

:::note[Advanced configuration]
[Row-level security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) is an advanced
PostgreSQL configuration that allows for granular user access to particular rows in a table.
Most deployments of Mundi don't benefit from row level security.
:::

Because Mundi simply connects to added PostGIS databases as the provided user in read-only mode, Mundi connections inherit the
row-level security of the existing database user and are treated as ordinary PostgreSQL connections.

Mundi does not administer or edit row security policies.
[AWS has a tutorial on enabling RLS](https://docs.aws.amazon.com/prescriptive-guidance/latest/saas-multitenant-managed-postgresql/rls.html).
